name: Build and Release APK

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'app/build.gradle.kts'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Extract version from build.gradle.kts
      id: version
      run: |
        VERSION_NAME=$(grep -oP 'versionName = "\K[^"]+' app/build.gradle.kts)
        VERSION_CODE=$(grep -oP 'versionCode = \K[0-9]+' app/build.gradle.kts)
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "Version: $VERSION_NAME (Code: $VERSION_CODE)"
        
    - name: Check if release already exists
      id: check_release
      run: |
        if gh release view "v${{ steps.version.outputs.version_name }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Release v${{ steps.version.outputs.version_name }} already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Release v${{ steps.version.outputs.version_name }} does not exist"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build Release APK
      if: steps.check_release.outputs.exists == 'false'
      run: ./gradlew assembleRelease
      
    - name: Sign APK
      if: steps.check_release.outputs.exists == 'false'
      id: sign_apk
      run: |
        APK_PATH="app/build/outputs/apk/release/app-release.apk"
        SIGNED_APK_PATH="app/build/outputs/apk/release/DinoDash-v${{ steps.version.outputs.version_name }}.apk"
        
        # APK íŒŒì¼ ì´ë¦„ ë³€ê²½
        mv "$APK_PATH" "$SIGNED_APK_PATH"
        
        echo "signed_apk_path=$SIGNED_APK_PATH" >> $GITHUB_OUTPUT
        
    - name: Generate Release Notes
      if: steps.check_release.outputs.exists == 'false'
      id: release_notes
      run: |
        cat > release_notes.md << EOF
        # ðŸŽ® DinoDash v${{ steps.version.outputs.version_name }}
        
        ## ðŸ“± ë‹¤ìš´ë¡œë“œ
        ì•„ëž˜ APK íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì„¤ì¹˜í•˜ì„¸ìš”!
        
        ## âœ¨ ì£¼ìš” ê¸°ëŠ¥
        - ðŸ± í”½ì…€ ì•„íŠ¸ ê³ ì–‘ì´ ìºë¦­í„°
        - ðŸ’§ ë¬¼ì›…ë©ì´ ìž¥ì• ë¬¼
        - ðŸ† ì—…ì  ì‹œìŠ¤í…œ (20ê°œ)
        - ðŸŒŸ ê³¨ë“œ ìŠ¤í‚¨ (ì í”„ 1000ë²ˆ ë‹¬ì„±)
        - ðŸ’€ í•´ê³¨ ìŠ¤í‚¨ (ë¹„ë°€ ì½”ë“œ: ddonddo)
        - ðŸŽµ ì‚¬ìš´ë“œ íš¨ê³¼
        - ðŸ”ï¸ ë°°ê²½ ìš”ì†Œ (êµ¬ë¦„, ì‚°)
        - ðŸ“œ ì—…ì ì°½ ìŠ¤í¬ë¡¤
        
        ## ðŸ”§ ì´ë²ˆ ë²„ì „ ë³€ê²½ì‚¬í•­
        - ì—…ì  ì•Œë¦¼ ë²„ê·¸ ìˆ˜ì •
        - ì£½ìŒ/í”Œë ˆì´/ì í”„ ê´€ë ¨ ì—…ì  ì•Œë¦¼ ì¶”ê°€
        
        ## ðŸ“¦ ì„¤ì¹˜ ë°©ë²•
        1. APK íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        2. ì•ˆë“œë¡œì´ë“œ ê¸°ê¸°ì—ì„œ "ì•Œ ìˆ˜ ì—†ëŠ” ì¶œì²˜" ì•± ì„¤ì¹˜ í—ˆìš©
        3. APK íŒŒì¼ ì‹¤í–‰í•˜ì—¬ ì„¤ì¹˜
        
        ## ðŸŽ¯ ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
        - Android 7.0 (API 24) ì´ìƒ
        EOF
        
    - name: Create GitHub Release
      if: steps.check_release.outputs.exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version_name }}
        name: DinoDash v${{ steps.version.outputs.version_name }}
        body_path: release_notes.md
        files: ${{ steps.sign_apk.outputs.signed_apk_path }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Release Summary
      if: steps.check_release.outputs.exists == 'false'
      run: |
        echo "ðŸŽ‰ Release v${{ steps.version.outputs.version_name }} created successfully!"
        echo "ðŸ“¦ APK: ${{ steps.sign_apk.outputs.signed_apk_path }}"

